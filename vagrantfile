Vagrant.configure("2") do |config|
  # Specify the box (Ubuntu 20.04 from Jeff Geerling)
  config.vm.box = "geerlingguy/ubuntu2004"
  config.vm.box_check_update = true

  # Port forwarding for app and database
  config.vm.network "forwarded_port", guest: 3000, host: 3000
  config.vm.network "forwarded_port", guest: 5000, host: 5000
  config.vm.network "forwarded_port", guest: 27017, host: 27017

  # VirtualBox resources
  config.vm.provider "virtualbox" do |vb|
    vb.memory = "2048"
    vb.cpus = 2
    vb.name = "ecommerce-app"
  end

  # Install Docker and pull images via shell script
  config.vm.provision "shell", inline: <<-SHELL
    echo "=== Installing Docker ==="
    if ! command -v docker &> /dev/null; then
      curl -fsSL https://get.docker.com | sudo sh
      sudo usermod -aG docker vagrant
      newgrp docker
    fi

    echo "=== Pulling Docker Images ==="
    docker pull mongo
    docker pull node:18

    echo "=== Running Containers ==="
    docker run -d --name yolo-mongo -p 27017:27017 mongo || echo "Mongo container already exists"
    # docker run -d --name backend -p 5000:5000 your-backend-image
    # docker run -d --name frontend -p 3000:3000 your-frontend-image
  SHELL

  # Ansible provisioning (after Docker setup)
  config.vm.provision "ansible" do |ansible|
    ansible.playbook = "playbook.yml"
    ansible.inventory_path = "localhost"
  end
end

